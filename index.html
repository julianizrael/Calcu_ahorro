<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Ahorros con Tramos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f8fb;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #0d47a1;
    }
    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
    }
    input[type="number"] {
      padding: 8px;
      font-size: 1rem;
    }
    canvas {
      max-width: 100%;
      height: auto;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: right;
    }
    th {
      background-color: #e3f2fd;
      color: #0d47a1;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #toggleTableBtn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de Ahorros con Tramos</h1>

    <div class="input-group">
      <label>Edad de inicio:
        <input type="number" id="startAge">
      </label>
      <label>Edad cambio 1:
        <input type="number" id="age1">
      </label>
      <label>Aporte tramo 1 ($/mes):
        <input type="number" id="contrib1">
      </label>

      <label>Edad cambio 2:
        <input type="number" id="age2">
      </label>
      <label>Aporte tramo 2 ($/mes):
        <input type="number" id="contrib2">
      </label>

      <label>Edad final:
        <input type="number" id="endAge">
      </label>
      <label>Aporte tramo 3 ($/mes):
        <input type="number" id="contrib3">
      </label>

      <label>Ahorro inicial ($):
        <input type="number" id="initialSavings">
      </label>
      <label>Rendimiento anual (%):
        <input type="number" id="annualReturn">
      </label>
    </div>

    <h3>Eventos únicos (gastos o ingresos puntuales)</h3>
    <div class="input-group">
      <label>Edad evento 1:
        <input type="number" id="eventAge1">
      </label>
      <label>Monto evento 1 ($):
        <input type="number" id="eventAmount1">
      </label>
      <label>Edad evento 2:
        <input type="number" id="eventAge2">
      </label>
      <label>Monto evento 2 ($):
        <input type="number" id="eventAmount2">
      </label>
      <label>Edad evento 3:
        <input type="number" id="eventAge3">
      </label>
      <label>Monto evento 3 ($):
        <input type="number" id="eventAmount3">
      </label>
    </div>

    <button onclick="calculateSavings()">Calcular</button>
    <div id="summary"></div>
    <canvas id="savingsChart"></canvas>
    <button id="toggleTableBtn" onclick="toggleTable()" style="display:none;">Mostrar tabla detallada</button>
    <div id="tableContainer" style="display:block;"></div>
  </div>

  <script>
    let chart;
    function toggleTable() {
      const container = document.getElementById("tableContainer");
      const btn = document.getElementById("toggleTableBtn");
      if (container.style.display === "none") {
        container.style.display = "block";
        btn.textContent = "Ocultar tabla detallada";
      } else {
        container.style.display = "none";
        btn.textContent = "Mostrar tabla detallada";
      }
    }

    function calculateSavings() {
      const startAge = parseInt(document.getElementById('startAge').value);
      const age1 = parseInt(document.getElementById('age1').value);
      const age2 = parseInt(document.getElementById('age2').value);
      const endAge = parseInt(document.getElementById('endAge').value);

      const contrib1 = parseFloat(document.getElementById('contrib1').value);
      const contrib2 = parseFloat(document.getElementById('contrib2').value);
      const contrib3 = parseFloat(document.getElementById('contrib3').value);
      const initialSavings = parseFloat(document.getElementById('initialSavings').value);
      const annualReturn = parseFloat(document.getElementById('annualReturn').value);

      const events = [
        { age: parseInt(document.getElementById('eventAge1').value), amount: parseFloat(document.getElementById('eventAmount1').value) },
        { age: parseInt(document.getElementById('eventAge2').value), amount: parseFloat(document.getElementById('eventAmount2').value) },
        { age: parseInt(document.getElementById('eventAge3').value), amount: parseFloat(document.getElementById('eventAmount3').value) }
      ].filter(e => !isNaN(e.age) && !isNaN(e.amount));

      const monthlyRate = annualReturn / 100 / 12;
      let savings = initialSavings;
      let results = [];
      let totalContribution = initialSavings;

      for (let age = startAge + 1; age <= endAge; age++) {
        let monthlyContribution = 0;
        if (age <= age1) monthlyContribution = contrib1;
        else if (age <= age2) monthlyContribution = contrib2;
        else monthlyContribution = contrib3;

        for (let m = 0; m < 12; m++) {
          savings += monthlyContribution;
          totalContribution += monthlyContribution;
          savings *= (1 + monthlyRate);
        }

        const event = events.find(e => e.age === age);
        if (event) savings += event.amount;

        results.push({
          age,
          total: savings,
          contribution: totalContribution,
          interest: savings - totalContribution
        });
      }

      const summary = document.getElementById("summary");
      const final = results[results.length - 1];
      summary.innerHTML = `
        <h3>Resumen:</h3>
        <p>Edad final: ${final.age}</p>
        <p>Total acumulado: $${final.total.toFixed(2)}</p>
        <p>Total aportado: $${final.contribution.toFixed(2)}</p>
        <p>Interés ganado: $${final.interest.toFixed(2)}</p>
      `;

      const ctx = document.getElementById("savingsChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: results.map(r => `Edad ${r.age}`),
          datasets: [
            {
              label: "Total acumulado",
              data: results.map(r => r.total),
              borderColor: "#1976d2",
              backgroundColor: "rgba(25, 118, 210, 0.2)",
              fill: true,
              tension: 0.3
            },
            {
              label: "Aporte acumulado",
              data: results.map(r => r.contribution),
              borderColor: "#64b5f6",
              borderDash: [5, 5],
              fill: false,
              tension: 0.3
            },
            {
              label: "Interés ganado",
              data: results.map(r => r.interest),
              borderColor: "#0d47a1",
              backgroundColor: "rgba(13, 71, 161, 0.1)",
              fill: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: $${ctx.raw.toFixed(2)}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => `$${value.toLocaleString()}`
              }
            }
          }
        }
      });

      const table = `
        <table>
          <thead>
            <tr>
              <th>Edad</th>
              <th>Total acumulado</th>
              <th>Aporte acumulado</th>
              <th>Interés ganado</th>
            </tr>
          </thead>
          <tbody>
            ${results.map(r => `
              <tr>
                <td>${r.age}</td>
                <td>$${r.total.toFixed(2)}</td>
                <td>$${r.contribution.toFixed(2)}</td>
                <td>$${r.interest.toFixed(2)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      const container = document.getElementById("tableContainer");
      container.innerHTML = table;
      container.style.display = 'block';
      const btn = document.getElementById("toggleTableBtn");
      btn.style.display = 'inline-block';
      btn.textContent = "Ocultar tabla detallada";
    }
  </script>
</body>
</html>
